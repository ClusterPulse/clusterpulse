
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Multi-cluster Kubernetes monitoring with RBAC">
      
      
      
      
        <link rel="prev" href="../cluster-controller/">
      
      
        <link rel="next" href="../../tests/api/">
      
      
        
      
      
      <link rel="icon" href="../../assets/logo.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Policy Controller - ClusterPulse Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#contributing-to-clusterpulse-policy-controller" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="ClusterPulse Documentation" class="md-header__button md-logo" aria-label="ClusterPulse Documentation" data-md-component="logo">
      
  <img src="../../assets/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ClusterPulse Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Policy Controller
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/ClusterPulse/clusterpulse" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    ClusterPulse/clusterpulse
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../getting-started/" class="md-tabs__link">
          
  
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../tutorials/" class="md-tabs__link">
          
  
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../how-to/" class="md-tabs__link">
          
  
  
  How-To Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../concepts/architecture/" class="md-tabs__link">
          
  
  
  Concepts

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../references/" class="md-tabs__link">
          
  
  
  References

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
  Contributing

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../tests/api/" class="md-tabs__link">
          
  
  
  Testing

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="ClusterPulse Documentation" class="md-nav__button md-logo" aria-label="ClusterPulse Documentation" data-md-component="logo">
      
  <img src="../../assets/logo.svg" alt="logo">

    </a>
    ClusterPulse Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ClusterPulse/clusterpulse" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    ClusterPulse/clusterpulse
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quickstart
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorials
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/rbac-basics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RBAC Basics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    How-To Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    How-To Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Index
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Clusters
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Clusters
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to/clusters/add-openshift-cluster/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Add OpenShift Cluster
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Policies
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Policies
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to/policies/create-readonly-policy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Create Read-Only Policy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to/policies/filter-by-namespace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Filter by Namespace
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_4" >
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Misc
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Misc
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to/external-redis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Use an External Redis Instance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Concepts
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/rbac-model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RBAC Model
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/policy-evaluation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Policy Evaluation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    References
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    References
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../references/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Index
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_2" >
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    CRDs
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    CRDs
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../references/crds/clusterconnection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ClusterConnection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../references/crds/monitoraccesspolicy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MonitorAccessPolicy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../references/crds/registryconnection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RegistryConnection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Contributing
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Index
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Development
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cluster-controller/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cluster Controller
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Policy Controller
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Policy Controller
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    <span class="md-ellipsis">
      
        Getting Started
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Getting Started">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#local-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Local Setup
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-locally" class="md-nav__link">
    <span class="md-ellipsis">
      
        Running Locally
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#development-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Development Dependencies
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#project-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Project Structure
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Project Structure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#file-organization" class="md-nav__link">
    <span class="md-ellipsis">
      
        File Organization
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#code-sections-in-policy_controllerpy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Code Sections in policy_controller.py
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Code Sections in policy_controller.py">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-constants-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Constants &amp; Configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Logging
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-exceptions" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Exceptions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-enums" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Enums
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-data-classes" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Data Classes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-utilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. Utilities
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-redis-connection" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. Redis Connection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-kubernetes-client" class="md-nav__link">
    <span class="md-ellipsis">
      
        9. Kubernetes Client
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#10-policy-compiler" class="md-nav__link">
    <span class="md-ellipsis">
      
        10. Policy Compiler
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#11-policy-store" class="md-nav__link">
    <span class="md-ellipsis">
      
        11. Policy Store
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-policy-validator" class="md-nav__link">
    <span class="md-ellipsis">
      
        12. Policy Validator
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-kopf-handlers" class="md-nav__link">
    <span class="md-ellipsis">
      
        13. Kopf Handlers
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#understanding-policy-compilation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Understanding Policy Compilation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Understanding Policy Compilation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#input-monitoraccesspolicy-crd" class="md-nav__link">
    <span class="md-ellipsis">
      
        Input: MonitorAccessPolicy CRD
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compilation-process" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compilation Process
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#output-compiledpolicy-in-redis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Output: CompiledPolicy in Redis
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redis-storage-and-indexing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Redis Storage and Indexing
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Common Tasks
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Common Tasks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adding-a-new-policy-field" class="md-nav__link">
    <span class="md-ellipsis">
      
        Adding a New Policy Field
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-a-new-resource-filter-type" class="md-nav__link">
    <span class="md-ellipsis">
      
        Adding a New Resource Filter Type
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-a-new-validation-rule" class="md-nav__link">
    <span class="md-ellipsis">
      
        Adding a New Validation Rule
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#changing-cache-invalidation-logic" class="md-nav__link">
    <span class="md-ellipsis">
      
        Changing Cache Invalidation Logic
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-a-new-metric" class="md-nav__link">
    <span class="md-ellipsis">
      
        Adding a New Metric
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modifying-periodic-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Modifying Periodic Validation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Testing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#running-tests" class="md-nav__link">
    <span class="md-ellipsis">
      
        Running Tests
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Code Patterns
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Code Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error Handling
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Logging
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redis-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Redis Operations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pattern-compilation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pattern Compilation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#status-updates" class="md-nav__link">
    <span class="md-ellipsis">
      
        Status Updates
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dataclass-serialization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dataclass Serialization
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Performance Considerations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Performance Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#batch-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Batch Operations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pattern-compilation-caching" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pattern Compilation Caching
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scan-instead-of-keys" class="md-nav__link">
    <span class="md-ellipsis">
      
        SCAN Instead of KEYS
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parallel-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parallel Operations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metrics-collection-overhead" class="md-nav__link">
    <span class="md-ellipsis">
      
        Metrics Collection Overhead
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-pitfalls" class="md-nav__link">
    <span class="md-ellipsis">
      
        Common Pitfalls
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-style" class="md-nav__link">
    <span class="md-ellipsis">
      
        Code Style
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pull-request-process" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pull Request Process
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coordination-with-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        Coordination with API
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quick-reference" class="md-nav__link">
    <span class="md-ellipsis">
      
        Quick Reference
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Quick Reference">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#environment-variables" class="md-nav__link">
    <span class="md-ellipsis">
      
        Environment Variables
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-redis-keys" class="md-nav__link">
    <span class="md-ellipsis">
      
        Common Redis Keys
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#useful-commands" class="md-nav__link">
    <span class="md-ellipsis">
      
        Useful Commands
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kopf-commands" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kopf Commands
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-help" class="md-nav__link">
    <span class="md-ellipsis">
      
        Getting Help
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#project-specific-notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Project-Specific Notes
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Testing
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Testing
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tests/api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Tests
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    <span class="md-ellipsis">
      
        Getting Started
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Getting Started">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#local-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Local Setup
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-locally" class="md-nav__link">
    <span class="md-ellipsis">
      
        Running Locally
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#development-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Development Dependencies
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#project-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Project Structure
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Project Structure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#file-organization" class="md-nav__link">
    <span class="md-ellipsis">
      
        File Organization
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#code-sections-in-policy_controllerpy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Code Sections in policy_controller.py
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Code Sections in policy_controller.py">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-constants-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Constants &amp; Configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Logging
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-exceptions" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Exceptions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-enums" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Enums
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-data-classes" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Data Classes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-utilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. Utilities
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-redis-connection" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. Redis Connection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-kubernetes-client" class="md-nav__link">
    <span class="md-ellipsis">
      
        9. Kubernetes Client
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#10-policy-compiler" class="md-nav__link">
    <span class="md-ellipsis">
      
        10. Policy Compiler
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#11-policy-store" class="md-nav__link">
    <span class="md-ellipsis">
      
        11. Policy Store
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-policy-validator" class="md-nav__link">
    <span class="md-ellipsis">
      
        12. Policy Validator
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-kopf-handlers" class="md-nav__link">
    <span class="md-ellipsis">
      
        13. Kopf Handlers
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#understanding-policy-compilation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Understanding Policy Compilation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Understanding Policy Compilation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#input-monitoraccesspolicy-crd" class="md-nav__link">
    <span class="md-ellipsis">
      
        Input: MonitorAccessPolicy CRD
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compilation-process" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compilation Process
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#output-compiledpolicy-in-redis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Output: CompiledPolicy in Redis
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redis-storage-and-indexing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Redis Storage and Indexing
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Common Tasks
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Common Tasks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adding-a-new-policy-field" class="md-nav__link">
    <span class="md-ellipsis">
      
        Adding a New Policy Field
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-a-new-resource-filter-type" class="md-nav__link">
    <span class="md-ellipsis">
      
        Adding a New Resource Filter Type
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-a-new-validation-rule" class="md-nav__link">
    <span class="md-ellipsis">
      
        Adding a New Validation Rule
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#changing-cache-invalidation-logic" class="md-nav__link">
    <span class="md-ellipsis">
      
        Changing Cache Invalidation Logic
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-a-new-metric" class="md-nav__link">
    <span class="md-ellipsis">
      
        Adding a New Metric
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modifying-periodic-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Modifying Periodic Validation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Testing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#running-tests" class="md-nav__link">
    <span class="md-ellipsis">
      
        Running Tests
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Code Patterns
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Code Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error Handling
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Logging
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redis-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Redis Operations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pattern-compilation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pattern Compilation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#status-updates" class="md-nav__link">
    <span class="md-ellipsis">
      
        Status Updates
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dataclass-serialization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dataclass Serialization
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Performance Considerations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Performance Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#batch-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Batch Operations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pattern-compilation-caching" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pattern Compilation Caching
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scan-instead-of-keys" class="md-nav__link">
    <span class="md-ellipsis">
      
        SCAN Instead of KEYS
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parallel-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parallel Operations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metrics-collection-overhead" class="md-nav__link">
    <span class="md-ellipsis">
      
        Metrics Collection Overhead
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-pitfalls" class="md-nav__link">
    <span class="md-ellipsis">
      
        Common Pitfalls
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-style" class="md-nav__link">
    <span class="md-ellipsis">
      
        Code Style
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pull-request-process" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pull Request Process
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coordination-with-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        Coordination with API
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quick-reference" class="md-nav__link">
    <span class="md-ellipsis">
      
        Quick Reference
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Quick Reference">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#environment-variables" class="md-nav__link">
    <span class="md-ellipsis">
      
        Environment Variables
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-redis-keys" class="md-nav__link">
    <span class="md-ellipsis">
      
        Common Redis Keys
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#useful-commands" class="md-nav__link">
    <span class="md-ellipsis">
      
        Useful Commands
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kopf-commands" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kopf Commands
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-help" class="md-nav__link">
    <span class="md-ellipsis">
      
        Getting Help
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#project-specific-notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Project-Specific Notes
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="contributing-to-clusterpulse-policy-controller">Contributing to ClusterPulse Policy Controller<a class="headerlink" href="#contributing-to-clusterpulse-policy-controller" title="Permanent link">&para;</a></h1>
<h2 id="getting-started">Getting Started<a class="headerlink" href="#getting-started" title="Permanent link">&para;</a></h2>
<h3 id="local-setup">Local Setup<a class="headerlink" href="#local-setup" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># Install uv (if not already installed)</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>curl<span class="w"> </span>-LsSf<span class="w"> </span>https://astral.sh/uv/install.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>sh
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="c1"># Install dependencies (uses uv.lock for reproducible builds)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="nb">cd</span><span class="w"> </span>policy-controller
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>uv<span class="w"> </span>sync
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="c1"># Set up environment</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="nb">export</span><span class="w"> </span><span class="nv">NAMESPACE</span><span class="o">=</span>clusterpulse
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="nb">export</span><span class="w"> </span><span class="nv">REDIS_HOST</span><span class="o">=</span>localhost
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="nb">export</span><span class="w"> </span><span class="nv">REDIS_PORT</span><span class="o">=</span><span class="m">6379</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="c1"># Start Redis</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>-p<span class="w"> </span><span class="m">6379</span>:6379<span class="w"> </span>redis:latest
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="c1"># Run locally (connects to your current kubeconfig cluster)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>uv<span class="w"> </span>run<span class="w"> </span>python<span class="w"> </span>policy_controller.py
</code></pre></div>
<h3 id="running-locally">Running Locally<a class="headerlink" href="#running-locally" title="Permanent link">&para;</a></h3>
<p>The policy controller can be run locally for development and testing. It will connect to whatever Kubernetes cluster your kubeconfig is pointing to.</p>
<p><strong>Prerequisites:</strong>
- A running Kubernetes/OpenShift cluster with the MonitorAccessPolicy CRD installed
- Redis running and accessible
- <code>KUBECONFIG</code> set or <code>~/.kube/config</code> configured</p>
<p><strong>Running with kopf:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nb">cd</span><span class="w"> </span>policy-controller
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="c1"># Run with default settings</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>uv<span class="w"> </span>run<span class="w"> </span>python<span class="w"> </span>policy_controller.py
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="c1"># Run with verbose logging</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>uv<span class="w"> </span>run<span class="w"> </span>kopf<span class="w"> </span>run<span class="w"> </span>policy_controller.py<span class="w"> </span>--verbose
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="c1"># Run in standalone mode (no leader election)</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>uv<span class="w"> </span>run<span class="w"> </span>kopf<span class="w"> </span>run<span class="w"> </span>policy_controller.py<span class="w"> </span>--standalone
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="c1"># Run watching a specific namespace</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>uv<span class="w"> </span>run<span class="w"> </span>kopf<span class="w"> </span>run<span class="w"> </span>policy_controller.py<span class="w"> </span>--namespace<span class="o">=</span>clusterpulse
</code></pre></div>
<p><strong>Environment variables for local development:</strong></p>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NAMESPACE</code></td>
<td><code>clusterpulse</code></td>
<td>Namespace to watch for policies</td>
</tr>
<tr>
<td><code>REDIS_HOST</code></td>
<td><code>redis</code></td>
<td>Redis hostname</td>
</tr>
<tr>
<td><code>REDIS_PORT</code></td>
<td><code>6379</code></td>
<td>Redis port</td>
</tr>
<tr>
<td><code>REDIS_PASSWORD</code></td>
<td>(none)</td>
<td>Redis password if required</td>
</tr>
<tr>
<td><code>REDIS_DB</code></td>
<td><code>0</code></td>
<td>Redis database number</td>
</tr>
<tr>
<td><code>POLICY_CACHE_TTL</code></td>
<td><code>300</code></td>
<td>Cache TTL in seconds</td>
</tr>
</tbody>
</table>
<h3 id="development-dependencies">Development Dependencies<a class="headerlink" href="#development-dependencies" title="Permanent link">&para;</a></h3>
<p>Development and test dependencies are included in <code>pyproject.toml</code> and managed by uv:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># Install all dependencies including dev/test</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>uv<span class="w"> </span>sync
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="c1"># Or install only production dependencies</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>uv<span class="w"> </span>sync<span class="w"> </span>--no-dev
</code></pre></div>
<h2 id="project-structure">Project Structure<a class="headerlink" href="#project-structure" title="Permanent link">&para;</a></h2>
<p>The policy-controller is a single Python file organized into logical sections. Here's what each part does.</p>
<h3 id="file-organization">File Organization<a class="headerlink" href="#file-organization" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>policy-controller/
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a> policy_controller.py    # Main controller (all sections below)
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a> pyproject.toml          # Python project configuration
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a> uv.lock                  # Locked dependencies for reproducible builds
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a> tests/                   # Tests (TODO)
</code></pre></div>
<h3 id="code-sections-in-policy_controllerpy">Code Sections in <code>policy_controller.py</code><a class="headerlink" href="#code-sections-in-policy_controllerpy" title="Permanent link">&para;</a></h3>
<p>The file is organized into these sections (in order):</p>
<h4 id="1-constants-configuration">1. Constants &amp; Configuration<a class="headerlink" href="#1-constants-configuration" title="Permanent link">&para;</a></h4>
<p>Environment variables and Redis key patterns.</p>
<p><strong>What's here:</strong>
- Environment configuration (REDIS_HOST, NAMESPACE, etc.)
- Policy settings (cache TTL, validation intervals)
- Redis key patterns for storing policies and indexes
- Batch processing constants</p>
<p><strong>When to edit:</strong>
- Adding new environment variables
- Changing default values
- Adding new Redis key patterns
- Adjusting batch sizes</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># Example: Adding a new configuration</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="n">POLICY_MAX_SIZE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POLICY_MAX_SIZE&quot;</span><span class="p">,</span> <span class="mi">100000</span><span class="p">))</span>  <span class="c1"># bytes</span>
</code></pre></div>
<h4 id="2-logging">2. Logging<a class="headerlink" href="#2-logging" title="Permanent link">&para;</a></h4>
<p>Basic logging configuration.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(name)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="p">)</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;policy-controller&quot;</span><span class="p">)</span>
</code></pre></div>
<h4 id="3-metrics">3. Metrics<a class="headerlink" href="#3-metrics" title="Permanent link">&para;</a></h4>
<p>Prometheus metrics for monitoring policy operations.</p>
<p><strong>Available metrics:</strong>
- <code>policy_compilation_duration_seconds</code> - Time to compile a policy
- <code>policy_cache_operations_total</code> - Cache operations counter
- <code>active_policies_total</code> - Number of active policies
- <code>policy_errors_total</code> - Error counter by type
- <code>redis_operation_duration_seconds</code> - Redis operation timings</p>
<p><strong>When to add:</strong>
- New performance metrics
- New error types to track
- New cache operations</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># Example: Adding a new metric</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">policy_validations</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>    <span class="s2">&quot;policy_validations_total&quot;</span><span class="p">,</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>    <span class="s2">&quot;Total policy validations&quot;</span><span class="p">,</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>    <span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="p">)</span>
</code></pre></div>
<h4 id="4-exceptions">4. Exceptions<a class="headerlink" href="#4-exceptions" title="Permanent link">&para;</a></h4>
<p>Custom exception hierarchy for policy errors.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">PolicyError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">PolicyCompilationError</span><span class="p">(</span><span class="n">PolicyError</span><span class="p">):</span> <span class="k">pass</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">PolicyValidationError</span><span class="p">(</span><span class="n">PolicyError</span><span class="p">):</span> <span class="k">pass</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">PolicyStorageError</span><span class="p">(</span><span class="n">PolicyError</span><span class="p">):</span> <span class="k">pass</span>
</code></pre></div>
<h4 id="5-enums">5. Enums<a class="headerlink" href="#5-enums" title="Permanent link">&para;</a></h4>
<p>Type-safe constants for policy effects, visibility, and states.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">PolicyEffect</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>    <span class="n">ALLOW</span> <span class="o">=</span> <span class="s2">&quot;Allow&quot;</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    <span class="n">DENY</span> <span class="o">=</span> <span class="s2">&quot;Deny&quot;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">PolicyState</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>    <span class="n">ACTIVE</span> <span class="o">=</span> <span class="s2">&quot;Active&quot;</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>    <span class="n">INACTIVE</span> <span class="o">=</span> <span class="s2">&quot;Inactive&quot;</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>    <span class="n">ERROR</span> <span class="o">=</span> <span class="s2">&quot;Error&quot;</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>    <span class="n">EXPIRED</span> <span class="o">=</span> <span class="s2">&quot;Expired&quot;</span>
</code></pre></div>
<h4 id="6-data-classes">6. Data Classes<a class="headerlink" href="#6-data-classes" title="Permanent link">&para;</a></h4>
<p>Compiled policy structures for efficient evaluation.</p>
<p><strong>Key classes:</strong>
- <code>CompiledResourceFilter</code> - Compiled resource filters (namespaces, nodes, operators, pods)
- <code>CompiledClusterRule</code> - Cluster access rules with filters
- <code>CompiledPolicy</code> - Complete compiled policy ready for Redis</p>
<p><strong>Critical:</strong> These classes define the Redis storage format. Changes here impact the API's RBAC engine.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nd">@dataclass</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">CompiledPolicy</span><span class="p">:</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="n">policy_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>    <span class="n">effect</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>    <span class="n">users</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>    <span class="n">groups</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>    <span class="n">service_accounts</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>    <span class="n">cluster_rules</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">CompiledClusterRule</span><span class="p">]</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>    <span class="c1"># ... more fields</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;This format MUST remain unchanged for Redis compatibility&quot;&quot;&quot;</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>        <span class="k">return</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
</code></pre></div>
<p><strong>Important:</strong> The <code>to_dict()</code> method creates the format that the API reads. Any changes must be coordinated with API changes.</p>
<h4 id="7-utilities">7. Utilities<a class="headerlink" href="#7-utilities" title="Permanent link">&para;</a></h4>
<p>Helper classes for batch processing and resource management.</p>
<p><strong>RedisBatchProcessor:</strong>
Efficiently batches Redis operations to avoid network overhead.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">with</span> <span class="n">RedisBatchProcessor</span><span class="p">(</span><span class="n">redis_client</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span> <span class="k">as</span> <span class="n">batch</span><span class="p">:</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>        <span class="n">batch</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span><span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span class="c1"># Auto-executes on context exit</span>
</code></pre></div>
<p><strong>ResourceManager:</strong>
Handles cleanup on shutdown (signal handlers, atexit).</p>
<h4 id="8-redis-connection">8. Redis Connection<a class="headerlink" href="#8-redis-connection" title="Permanent link">&para;</a></h4>
<p>Connection pool for Redis client.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">redis_pool</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">ConnectionPool</span><span class="p">(</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>    <span class="n">host</span><span class="o">=</span><span class="n">REDIS_HOST</span><span class="p">,</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>    <span class="n">port</span><span class="o">=</span><span class="n">REDIS_PORT</span><span class="p">,</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>    <span class="n">max_connections</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="p">)</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="n">redis_client</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="n">connection_pool</span><span class="o">=</span><span class="n">redis_pool</span><span class="p">)</span>
</code></pre></div>
<h4 id="9-kubernetes-client">9. Kubernetes Client<a class="headerlink" href="#9-kubernetes-client" title="Permanent link">&para;</a></h4>
<p>Connection to the Kubernetes API.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">config</span><span class="o">.</span><span class="n">load_incluster_config</span><span class="p">()</span>  <span class="c1"># In cluster</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="c1"># or</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="n">config</span><span class="o">.</span><span class="n">load_kube_config</span><span class="p">()</span>  <span class="c1"># Local dev</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="n">k8s_client</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ApiClient</span><span class="p">()</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="n">dynamic_client</span> <span class="o">=</span> <span class="n">DynamicClient</span><span class="p">(</span><span class="n">k8s_client</span><span class="p">)</span>
</code></pre></div>
<h4 id="10-policy-compiler">10. Policy Compiler<a class="headerlink" href="#10-policy-compiler" title="Permanent link">&para;</a></h4>
<p>Compiles MonitorAccessPolicy CRDs into efficient structures.</p>
<p><strong>Main method:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">compile_policy</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CompiledPolicy</span>
</code></pre></div></p>
<p><strong>What it does:</strong>
1. Validates the policy spec (new format)
2. Extracts subjects (users, groups, service accounts)
3. Compiles cluster rules with resource filters
4. Processes patterns into regex or literals
5. Extracts validity periods and audit config
6. Generates a hash for change detection
7. Returns a CompiledPolicy object</p>
<p><strong>Pattern compilation:</strong>
- Literal strings stored as-is for fast lookup
- Wildcards (<code>*</code>, <code>?</code>) compiled to regex
- Results cached with <code>@lru_cache</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">_compile_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>    <span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">pattern</span> <span class="ow">or</span> <span class="s2">&quot;?&quot;</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">:</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>        <span class="c1"># Convert to regex</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;regex&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;^</span><span class="si">{</span><span class="n">regex_pattern</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;literal&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
</code></pre></div>
<h4 id="11-policy-store">11. Policy Store<a class="headerlink" href="#11-policy-store" title="Permanent link">&para;</a></h4>
<p>Manages policy storage and indexing in Redis.</p>
<p><strong>Main methods:</strong>
- <code>store_policy(policy)</code> - Store compiled policy with indexes
- <code>remove_policy(namespace, name)</code> - Remove policy and indexes
- <code>_invalidate_evaluation_caches(...)</code> - Clear caches for affected users/groups</p>
<p><strong>Redis structure:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>policy:{namespace}:{name}              # Policy data (hash)
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>policy:user:{user}                     # User&#39;s policies (set)
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>policy:user:{user}:sorted              # Sorted by priority (zset)
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>policy:group:{group}                   # Group&#39;s policies (set)
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>policy:group:{group}:sorted            # Sorted by priority (zset)
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>policy:sa:{sa}                         # Service account policies (set)
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>policies:all                           # All policies (set)
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>policies:enabled                       # Only enabled policies (set)
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>policies:by:priority                   # All policies by priority (zset)
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>policy:eval:{identity}:{cluster}       # Evaluation cache
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>user:groups:{username}                 # User&#39;s group membership
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>group:members:{group}                  # Group&#39;s members
</code></pre></div></p>
<p><strong>Indexing strategy:</strong>
- Policies indexed by user, group, and service account
- Priority-sorted sets for efficient lookup
- Global indexes for all policies
- Evaluation caches for performance</p>
<p><strong>Cache invalidation:</strong>
When a policy changes, all affected evaluation caches must be cleared:
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">_invalidate_evaluation_caches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">service_accounts</span><span class="p">):</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>    <span class="c1"># Clear user caches</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>    <span class="c1"># Clear group member caches</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>    <span class="c1"># Clear service account caches</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>    <span class="c1"># Uses SCAN to find and delete matching keys</span>
</code></pre></div></p>
<h4 id="12-policy-validator">12. Policy Validator<a class="headerlink" href="#12-policy-validator" title="Permanent link">&para;</a></h4>
<p>Validates policies for expiration and conditions.</p>
<p><strong>Main methods:</strong>
- <code>validate_policy(namespace, name, spec)</code> - Validate single policy
- <code>validate_all_policies()</code> - Periodic validation of all policies</p>
<p><strong>Validation checks:</strong>
- <code>notBefore</code> date - Policy not yet valid
- <code>notAfter</code> date - Policy expired
- <code>enabled</code> flag - Policy disabled</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">validate_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>    <span class="k">if</span> <span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notBefore&quot;</span><span class="p">):</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>        <span class="n">not_before</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>        <span class="k">if</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="n">not_before</span><span class="p">:</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;Inactive&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Not yet valid&quot;</span><span class="p">}</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>    <span class="k">if</span> <span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notAfter&quot;</span><span class="p">):</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>        <span class="n">not_after</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>        <span class="k">if</span> <span class="n">now</span> <span class="o">&gt;</span> <span class="n">not_after</span><span class="p">:</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;Expired&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Policy expired&quot;</span><span class="p">}</span>
</code></pre></div>
<h4 id="13-kopf-handlers">13. Kopf Handlers<a class="headerlink" href="#13-kopf-handlers" title="Permanent link">&para;</a></h4>
<p>Kubernetes operator event handlers using kopf framework.</p>
<p><strong>Handlers:</strong></p>
<p><strong><code>@kopf.on.create</code> / <code>@kopf.on.update</code></strong>
- Triggered when MonitorAccessPolicy is created/updated
- Compiles the policy
- Stores in Redis
- Validates and updates status</p>
<p><strong><code>@kopf.on.delete</code></strong>
- Triggered when MonitorAccessPolicy is deleted
- Removes from Redis
- Clears all indexes</p>
<p><strong><code>@kopf.timer</code></strong>
- Periodic validation (every 5 minutes)
- Checks for expired policies
- Updates status if state changed</p>
<p><strong><code>@kopf.on.startup</code></strong>
- Initializes Redis connection
- Clears stale caches
- Starts background tasks</p>
<p><strong><code>@kopf.on.cleanup</code></strong>
- Closes Redis connection
- Cleanup on shutdown</p>
<p><strong><code>@kopf.on.probe</code></strong>
- Health check endpoint
- Returns policy counts</p>
<h2 id="understanding-policy-compilation">Understanding Policy Compilation<a class="headerlink" href="#understanding-policy-compilation" title="Permanent link">&para;</a></h2>
<p>Policy compilation is the core function. Here's how it works:</p>
<h3 id="input-monitoraccesspolicy-crd">Input: MonitorAccessPolicy CRD<a class="headerlink" href="#input-monitoraccesspolicy-crd" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">clusterpulse.io/v1alpha1</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MonitorAccessPolicy</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dev-team-policy</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">clusterpulse</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">  </span><span class="nt">identity</span><span class="p">:</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">    </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">    </span><span class="nt">subjects</span><span class="p">:</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w">      </span><span class="nt">users</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;john.doe&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;jane.smith&quot;</span><span class="p p-Indicator">]</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="w">      </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;developers&quot;</span><span class="p p-Indicator">]</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w">  </span><span class="nt">access</span><span class="p">:</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="w">    </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="w">  </span><span class="nt">scope</span><span class="p">:</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="w">    </span><span class="nt">clusters</span><span class="p">:</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="w">      </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">none</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="w">      </span><span class="nt">rules</span><span class="p">:</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="w">            </span><span class="nt">names</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;dev-*&quot;</span><span class="p p-Indicator">]</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="w">          </span><span class="nt">permissions</span><span class="p">:</span>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="w">            </span><span class="nt">view</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a><span class="w">            </span><span class="nt">viewMetrics</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="w">          </span><span class="nt">resources</span><span class="p">:</span>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="w">            </span><span class="nt">namespaces</span><span class="p">:</span>
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a><span class="w">              </span><span class="nt">visibility</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">filtered</span>
<a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a><span class="w">              </span><span class="nt">filters</span><span class="p">:</span>
<a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a><span class="w">                </span><span class="nt">allowed</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;team-a-*&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;shared-*&quot;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<h3 id="compilation-process">Compilation Process<a class="headerlink" href="#compilation-process" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Validation:</strong></li>
<li>Check required sections (identity, access, scope)</li>
<li>Validate effect (Allow/Deny)</li>
<li>
<p>Validate priority (must be &gt;= 0)</p>
</li>
<li>
<p><strong>Extract Subjects:</strong>
   <div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">users</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;john.doe&quot;</span><span class="p">,</span> <span class="s2">&quot;jane.smith&quot;</span><span class="p">])</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="n">groups</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;developers&quot;</span><span class="p">])</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="n">service_accounts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># Converted to k8s format</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Compile Cluster Rules:</strong></p>
</li>
<li>Process each rule's selector and permissions</li>
<li>Compile resource filters (namespaces, nodes, operators, pods)</li>
<li>
<p>Convert patterns to regex or literals</p>
</li>
<li>
<p><strong>Pattern Compilation:</strong>
   <div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="s2">&quot;team-a-*&quot;</span> <span class="err"></span> <span class="n">regex</span><span class="p">:</span> <span class="o">^</span><span class="n">team</span><span class="o">-</span><span class="n">a</span><span class="o">-.*</span><span class="err">$</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="s2">&quot;shared-prod&quot;</span> <span class="err"></span> <span class="n">literal</span><span class="p">:</span> <span class="s2">&quot;shared-prod&quot;</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Generate Hash:</strong></p>
</li>
<li>Hash the entire spec for change detection</li>
<li>Used by API to detect policy changes</li>
</ol>
<h3 id="output-compiledpolicy-in-redis">Output: CompiledPolicy in Redis<a class="headerlink" href="#output-compiledpolicy-in-redis" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="p">{</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>    <span class="s2">&quot;policy_name&quot;</span><span class="p">:</span> <span class="s2">&quot;dev-team-policy&quot;</span><span class="p">,</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>    <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;clusterpulse&quot;</span><span class="p">,</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>    <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>    <span class="s2">&quot;effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>    <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>    <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;john.doe&quot;</span><span class="p">,</span> <span class="s2">&quot;jane.smith&quot;</span><span class="p">],</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>    <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;developers&quot;</span><span class="p">],</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>    <span class="s2">&quot;cluster_rules&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>        <span class="p">{</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>            <span class="s2">&quot;cluster_selector&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;names&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;dev-*&quot;</span><span class="p">]},</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>            <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;view&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;viewMetrics&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>            <span class="s2">&quot;namespace_filter&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>                <span class="s2">&quot;visibility&quot;</span><span class="p">:</span> <span class="s2">&quot;filtered&quot;</span><span class="p">,</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>                <span class="s2">&quot;allowed_patterns&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;team-a-*&quot;</span><span class="p">,</span> <span class="s2">&quot;^team-a-.*$&quot;</span><span class="p">)],</span>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>                <span class="s2">&quot;allowed_literals&quot;</span><span class="p">:</span> <span class="p">[],</span>
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>                <span class="o">...</span>
<a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a>            <span class="p">}</span>
<a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a>        <span class="p">}</span>
<a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a>    <span class="p">],</span>
<a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a>    <span class="s2">&quot;compiled_at&quot;</span><span class="p">:</span> <span class="s2">&quot;2025-01-15T10:30:00Z&quot;</span><span class="p">,</span>
<a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>    <span class="s2">&quot;hash&quot;</span><span class="p">:</span> <span class="s2">&quot;a1b2c3d4e5f6&quot;</span>
<a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a><span class="p">}</span>
</code></pre></div>
<h3 id="redis-storage-and-indexing">Redis Storage and Indexing<a class="headerlink" href="#redis-storage-and-indexing" title="Permanent link">&para;</a></h3>
<p>When stored, the policy is indexed multiple ways:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a># Main policy data
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>SET policy:clusterpulse:dev-team-policy {...}
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a># Index by users
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>SADD policy:user:john.doe policy:clusterpulse:dev-team-policy
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>ZADD policy:user:john.doe:sorted 100 policy:clusterpulse:dev-team-policy
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a># Index by groups
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>SADD policy:group:developers policy:clusterpulse:dev-team-policy
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>ZADD policy:group:developers:sorted 100 policy:clusterpulse:dev-team-policy
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a># Global indexes
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>SADD policies:all policy:clusterpulse:dev-team-policy
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>SADD policies:enabled policy:clusterpulse:dev-team-policy
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>ZADD policies:by:priority 100 policy:clusterpulse:dev-team-policy
</code></pre></div>
<p>This allows the API to quickly find all policies for a user/group sorted by priority.</p>
<h2 id="common-tasks">Common Tasks<a class="headerlink" href="#common-tasks" title="Permanent link">&para;</a></h2>
<h3 id="adding-a-new-policy-field">Adding a New Policy Field<a class="headerlink" href="#adding-a-new-policy-field" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Update the validation:</strong></li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">_validate_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>    <span class="c1"># Add validation for new field</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>    <span class="k">if</span> <span class="s2">&quot;newSection&quot;</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>        <span class="n">new_value</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;newSection&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;newField&quot;</span><span class="p">)</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>        <span class="k">if</span> <span class="n">new_value</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>            <span class="k">raise</span> <span class="n">PolicyValidationError</span><span class="p">(</span><span class="s2">&quot;newField must be a string&quot;</span><span class="p">)</span>
</code></pre></div>
<ol>
<li><strong>Extract the field during compilation:</strong></li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">compile_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CompiledPolicy</span><span class="p">:</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>    <span class="c1"># Extract new field</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>    <span class="n">new_section</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;newSection&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>    <span class="n">new_value</span> <span class="o">=</span> <span class="n">new_section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;newField&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>    <span class="c1"># Add to compiled policy</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>    <span class="k">return</span> <span class="n">CompiledPolicy</span><span class="p">(</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>        <span class="c1"># ... existing fields</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>        <span class="n">new_field</span><span class="o">=</span><span class="n">new_value</span><span class="p">,</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>    <span class="p">)</span>
</code></pre></div>
<ol>
<li><strong>Add to CompiledPolicy dataclass:</strong></li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="nd">@dataclass</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">CompiledPolicy</span><span class="p">:</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>    <span class="c1"># ... existing fields</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>    <span class="n">new_field</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>            <span class="c1"># ... existing fields</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>            <span class="s2">&quot;new_field&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_field</span><span class="p">,</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>        <span class="p">}</span>
</code></pre></div>
<ol>
<li><strong>Update the CRD</strong> (in another repository):</li>
<li>Add the field to the OpenAPI schema</li>
<li>Update examples and documentation</li>
</ol>
<h3 id="adding-a-new-resource-filter-type">Adding a New Resource Filter Type<a class="headerlink" href="#adding-a-new-resource-filter-type" title="Permanent link">&para;</a></h3>
<p>If you need to filter a new resource type (e.g., ConfigMaps):</p>
<ol>
<li><strong>Add compilation method:</strong></li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">_compile_configmap_filter</span><span class="p">(</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>    <span class="bp">self</span><span class="p">,</span> <span class="n">visibility</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filters</span><span class="p">:</span> <span class="n">Dict</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CompiledResourceFilter</span><span class="p">:</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compile configmap-specific filters&quot;&quot;&quot;</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>    <span class="n">filter_obj</span> <span class="o">=</span> <span class="n">CompiledResourceFilter</span><span class="p">(</span><span class="n">visibility</span><span class="o">=</span><span class="n">visibility</span><span class="p">)</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>    <span class="c1"># Process namespace filters</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>    <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allowedNamespaces&quot;</span><span class="p">,</span> <span class="p">[]):</span>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>        <span class="n">compiled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>        <span class="k">if</span> <span class="n">compiled</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;literal&quot;</span><span class="p">:</span>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a>            <span class="n">filter_obj</span><span class="o">.</span><span class="n">allowed_literals</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">compiled</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a>            <span class="n">filter_obj</span><span class="o">.</span><span class="n">allowed_patterns</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pattern</span><span class="p">,</span> <span class="n">compiled</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a>    <span class="c1"># Add configmap-specific filters</span>
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a>    <span class="k">if</span> <span class="s2">&quot;maxDataSize&quot;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a>        <span class="n">filter_obj</span><span class="o">.</span><span class="n">additional_filters</span><span class="p">[</span><span class="s2">&quot;max_data_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filters</span><span class="p">[</span><span class="s2">&quot;maxDataSize&quot;</span><span class="p">]</span>
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a>
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a>    <span class="k">return</span> <span class="n">filter_obj</span>
</code></pre></div>
<ol>
<li><strong>Add to cluster rules compilation:</strong></li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">_compile_cluster_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clusters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">CompiledClusterRule</span><span class="p">]:</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>    <span class="c1"># ... existing code</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>    <span class="c1"># Process configmaps</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>    <span class="k">if</span> <span class="s2">&quot;configmaps&quot;</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>        <span class="n">cm_config</span> <span class="o">=</span> <span class="n">resources</span><span class="p">[</span><span class="s2">&quot;configmaps&quot;</span><span class="p">]</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>        <span class="n">configmap_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_configmap_filter</span><span class="p">(</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>            <span class="n">cm_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;visibility&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">),</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>            <span class="n">cm_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filters&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>        <span class="p">)</span>
</code></pre></div>
<ol>
<li><strong>Add field to CompiledClusterRule:</strong></li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="nd">@dataclass</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">CompiledClusterRule</span><span class="p">:</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>    <span class="c1"># ... existing fields</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>    <span class="n">configmap_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CompiledResourceFilter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>            <span class="c1"># ... existing fields</span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>            <span class="s2">&quot;configmap_filter&quot;</span><span class="p">:</span> <span class="p">(</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">configmap_filter</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configmap_filter</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a>            <span class="p">),</span>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a>        <span class="p">}</span>
</code></pre></div>
<h3 id="adding-a-new-validation-rule">Adding a New Validation Rule<a class="headerlink" href="#adding-a-new-validation-rule" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Add to <code>_validate_spec</code>:</strong></li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">_validate_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>    <span class="c1"># ... existing validations</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>    <span class="c1"># New validation</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>    <span class="n">scope</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>    <span class="n">restrictions</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;restrictions&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>    <span class="k">if</span> <span class="s2">&quot;maxClusters&quot;</span> <span class="ow">in</span> <span class="n">restrictions</span><span class="p">:</span>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>        <span class="n">max_clusters</span> <span class="o">=</span> <span class="n">restrictions</span><span class="p">[</span><span class="s2">&quot;maxClusters&quot;</span><span class="p">]</span>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_clusters</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">max_clusters</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a>            <span class="k">raise</span> <span class="n">PolicyValidationError</span><span class="p">(</span><span class="s2">&quot;maxClusters must be &gt;= 1&quot;</span><span class="p">)</span>
</code></pre></div>
<ol>
<li><strong>Use during compilation:</strong></li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">compile_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>        <span class="c1"># ... continue compilation</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>    <span class="k">except</span> <span class="n">PolicyValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>        <span class="n">policy_errors</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">error_type</span><span class="o">=</span><span class="s2">&quot;validation&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a>        <span class="k">raise</span>
</code></pre></div>
<h3 id="changing-cache-invalidation-logic">Changing Cache Invalidation Logic<a class="headerlink" href="#changing-cache-invalidation-logic" title="Permanent link">&para;</a></h3>
<p>When policies change, caches must be cleared. To modify this:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">_invalidate_evaluation_caches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">service_accounts</span><span class="p">):</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>    <span class="k">with</span> <span class="n">RedisBatchProcessor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="p">)</span> <span class="k">as</span> <span class="n">batch</span><span class="p">:</span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>        <span class="c1"># Clear user caches</span>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>            <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;policy:eval:</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">:*&quot;</span>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>            <span class="n">count</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan_and_delete</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>            <span class="c1"># Add new cache type</span>
<a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>            <span class="n">batch</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span><span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;user:computed_permissions:</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a>
<a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a>        <span class="c1"># ... rest of invalidation</span>
</code></pre></div>
<h3 id="adding-a-new-metric">Adding a New Metric<a class="headerlink" href="#adding-a-new-metric" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="c1"># At top of file with other metrics</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="n">policy_size_bytes</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>    <span class="s2">&quot;policy_size_bytes&quot;</span><span class="p">,</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>    <span class="s2">&quot;Size of compiled policies in bytes&quot;</span><span class="p">,</span>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>    <span class="p">[</span><span class="s2">&quot;namespace&quot;</span><span class="p">]</span>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="p">)</span>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="c1"># Use in code</span>
<a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">store_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">CompiledPolicy</span><span class="p">):</span>
<a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a>    <span class="n">policy_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
<a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a>
<a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a>    <span class="c1"># Record metric</span>
<a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a>    <span class="n">policy_size_bytes</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">namespace</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">namespace</span><span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">policy_data</span><span class="p">))</span>
<a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a>
<a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a>    <span class="c1"># Store in Redis</span>
<a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a>    <span class="c1"># ...</span>
</code></pre></div>
<h3 id="modifying-periodic-validation">Modifying Periodic Validation<a class="headerlink" href="#modifying-periodic-validation" title="Permanent link">&para;</a></h3>
<p>The timer handler runs every 5 minutes by default:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="nd">@kopf</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>    <span class="s2">&quot;clusterpulse.io&quot;</span><span class="p">,</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>    <span class="s2">&quot;v1alpha1&quot;</span><span class="p">,</span>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>    <span class="s2">&quot;monitoraccesspolicies&quot;</span><span class="p">,</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>    <span class="n">interval</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>  <span class="c1"># Change this value</span>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="p">)</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">periodic_policy_validation</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>    <span class="c1"># Validation logic</span>
</code></pre></div>
<p>To make it configurable:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="c1"># Add to constants</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="n">POLICY_VALIDATION_INTERVAL</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POLICY_VALIDATION_INTERVAL&quot;</span><span class="p">,</span> <span class="mi">300</span><span class="p">))</span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="c1"># Use in handler</span>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="nd">@kopf</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span>
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>    <span class="s2">&quot;clusterpulse.io&quot;</span><span class="p">,</span>
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>    <span class="s2">&quot;v1alpha1&quot;</span><span class="p">,</span>
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>    <span class="s2">&quot;monitoraccesspolicies&quot;</span><span class="p">,</span>
<a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a>    <span class="n">interval</span><span class="o">=</span><span class="n">POLICY_VALIDATION_INTERVAL</span><span class="p">,</span>
<a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="p">)</span>
</code></pre></div>
<h2 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">&para;</a></h2>
<p>Tests should cover:</p>
<ol>
<li><strong>Policy compilation:</strong></li>
<li>Valid policy specs compile correctly</li>
<li>Invalid specs raise appropriate errors</li>
<li>Pattern compilation (literals vs regex)</li>
<li>
<p>Filter compilation for each resource type</p>
</li>
<li>
<p><strong>Redis storage:</strong></p>
</li>
<li>Policies stored with correct indexes</li>
<li>Cache invalidation clears correct keys</li>
<li>
<p>Batch operations work correctly</p>
</li>
<li>
<p><strong>Validation:</strong></p>
</li>
<li>Time-based validation (notBefore, notAfter)</li>
<li>Enabled/disabled flag handling</li>
<li>
<p>State transitions</p>
</li>
<li>
<p><strong>Kopf handlers:</strong></p>
</li>
<li>Create/update handlers compile and store</li>
<li>Delete handler removes all traces</li>
<li>Status updates work correctly</li>
</ol>
<p><strong>Test pattern:</strong> - TODO</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">fakeredis</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">policy_controller</span><span class="w"> </span><span class="kn">import</span> <span class="n">PolicyCompiler</span><span class="p">,</span> <span class="n">PolicyStore</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">fake_redis</span><span class="p">():</span>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>    <span class="k">return</span> <span class="n">fakeredis</span><span class="o">.</span><span class="n">FakeRedis</span><span class="p">(</span><span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_compile_basic_policy</span><span class="p">():</span>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a>    <span class="n">compiler</span> <span class="o">=</span> <span class="n">PolicyCompiler</span><span class="p">()</span>
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a>
<a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a>    <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a>        <span class="s2">&quot;identity&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a>            <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
<a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a>            <span class="s2">&quot;subjects&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;test.user&quot;</span><span class="p">]}</span>
<a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a>        <span class="p">},</span>
<a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a>        <span class="s2">&quot;access&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span> <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
<a id="__codelineno-35-18" name="__codelineno-35-18" href="#__codelineno-35-18"></a>        <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-35-19" name="__codelineno-35-19" href="#__codelineno-35-19"></a>            <span class="s2">&quot;clusters&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;rules&quot;</span><span class="p">:</span> <span class="p">[]}</span>
<a id="__codelineno-35-20" name="__codelineno-35-20" href="#__codelineno-35-20"></a>        <span class="p">}</span>
<a id="__codelineno-35-21" name="__codelineno-35-21" href="#__codelineno-35-21"></a>    <span class="p">}</span>
<a id="__codelineno-35-22" name="__codelineno-35-22" href="#__codelineno-35-22"></a>
<a id="__codelineno-35-23" name="__codelineno-35-23" href="#__codelineno-35-23"></a>    <span class="n">policy</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">compile_policy</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
<a id="__codelineno-35-24" name="__codelineno-35-24" href="#__codelineno-35-24"></a>
<a id="__codelineno-35-25" name="__codelineno-35-25" href="#__codelineno-35-25"></a>    <span class="k">assert</span> <span class="n">policy</span><span class="o">.</span><span class="n">policy_name</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span>
<a id="__codelineno-35-26" name="__codelineno-35-26" href="#__codelineno-35-26"></a>    <span class="k">assert</span> <span class="n">policy</span><span class="o">.</span><span class="n">priority</span> <span class="o">==</span> <span class="mi">100</span>
<a id="__codelineno-35-27" name="__codelineno-35-27" href="#__codelineno-35-27"></a>    <span class="k">assert</span> <span class="s2">&quot;test.user&quot;</span> <span class="ow">in</span> <span class="n">policy</span><span class="o">.</span><span class="n">users</span>
<a id="__codelineno-35-28" name="__codelineno-35-28" href="#__codelineno-35-28"></a>    <span class="k">assert</span> <span class="n">policy</span><span class="o">.</span><span class="n">enabled</span> <span class="ow">is</span> <span class="kc">True</span>
</code></pre></div>
<p>See <code>docs/api/tests.md</code> for more testing patterns.</p>
<h3 id="running-tests">Running Tests<a class="headerlink" href="#running-tests" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="c1"># All tests</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>uv<span class="w"> </span>run<span class="w"> </span>pytest
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="c1"># Specific category</span>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>uv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span>unit
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>uv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span>integration
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="c1"># With coverage</span>
<a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>uv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w"> </span>--cov<span class="o">=</span>.<span class="w"> </span>--cov-report<span class="o">=</span>html
<a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a>
<a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a><span class="c1"># Single test</span>
<a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a>uv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w"> </span>tests/test_compiler.py::test_compile_basic_policy<span class="w"> </span>-v
</code></pre></div>
<h2 id="code-patterns">Code Patterns<a class="headerlink" href="#code-patterns" title="Permanent link">&para;</a></h2>
<h3 id="error-handling">Error Handling<a class="headerlink" href="#error-handling" title="Permanent link">&para;</a></h3>
<p>Always wrap errors with context:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>    <span class="n">compiled</span> <span class="o">=</span> <span class="n">policy_compiler</span><span class="o">.</span><span class="n">compile_policy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="k">except</span> <span class="n">PolicyValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>    <span class="n">policy_errors</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">error_type</span><span class="o">=</span><span class="s2">&quot;validation&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>    <span class="k">raise</span> <span class="n">PolicyCompilationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to compile </span><span class="si">{</span><span class="n">namespace</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Use specific exception types:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>    <span class="k">raise</span> <span class="n">PolicyValidationError</span><span class="p">(</span><span class="s2">&quot;Policy spec must be a dictionary&quot;</span><span class="p">)</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="k">if</span> <span class="n">redis_error</span><span class="p">:</span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>    <span class="k">raise</span> <span class="n">PolicyStorageError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to store policy: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="logging">Logging<a class="headerlink" href="#logging" title="Permanent link">&para;</a></h3>
<p>Use appropriate log levels:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="c1"># Info - important state changes</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stored policy </span><span class="si">{</span><span class="n">policy_key</span><span class="si">}</span><span class="s2"> and cleared evaluation caches&quot;</span><span class="p">)</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="c1"># Debug - detailed operations</span>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cleared </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> evaluation cache entries&quot;</span><span class="p">)</span>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a>
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="c1"># Warning - unusual but handled</span>
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Policy </span><span class="si">{</span><span class="n">policy_key</span><span class="si">}</span><span class="s2"> not found for removal&quot;</span><span class="p">)</span>
<a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a>
<a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a><span class="c1"># Error - actual problems</span>
<a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to compile policy </span><span class="si">{</span><span class="n">namespace</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="redis-operations">Redis Operations<a class="headerlink" href="#redis-operations" title="Permanent link">&para;</a></h3>
<p>Use batch operations for efficiency:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="k">with</span> <span class="n">RedisBatchProcessor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span> <span class="k">as</span> <span class="n">batch</span><span class="p">:</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">policy</span><span class="o">.</span><span class="n">users</span><span class="p">:</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a>        <span class="n">batch</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span><span class="s2">&quot;sadd&quot;</span><span class="p">,</span> <span class="n">user_key</span><span class="p">,</span> <span class="n">policy_key</span><span class="p">)</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a>        <span class="n">batch</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span><span class="s2">&quot;zadd&quot;</span><span class="p">,</span> <span class="n">sorted_key</span><span class="p">,</span> <span class="p">{</span><span class="n">policy_key</span><span class="p">:</span> <span class="n">priority</span><span class="p">})</span>
</code></pre></div>
<p>Use SCAN for large key sets:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a>    <span class="n">cursor</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a>        <span class="n">cursor</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">REDIS_SCAN_BATCH_SIZE</span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a>    <span class="p">)</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a>        <span class="n">batch</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span><span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a>    <span class="k">if</span> <span class="n">cursor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a>        <span class="k">break</span>
</code></pre></div>
<h3 id="pattern-compilation">Pattern Compilation<a class="headerlink" href="#pattern-compilation" title="Permanent link">&para;</a></h3>
<p>Cache compiled patterns:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">_compile_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>    <span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">pattern</span> <span class="ow">or</span> <span class="s2">&quot;?&quot;</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">:</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>        <span class="n">regex_pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\.&quot;</span><span class="p">)</span>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>        <span class="n">regex_pattern</span> <span class="o">=</span> <span class="n">regex_pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;.*&quot;</span><span class="p">)</span>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a>        <span class="n">regex_pattern</span> <span class="o">=</span> <span class="n">regex_pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;regex&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;^</span><span class="si">{</span><span class="n">regex_pattern</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a>        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;literal&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
</code></pre></div>
<p>Separate literals from patterns for performance:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allowed&quot;</span><span class="p">,</span> <span class="p">[]):</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>    <span class="n">compiled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>    <span class="k">if</span> <span class="n">compiled</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;literal&quot;</span><span class="p">:</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>        <span class="n">filter_obj</span><span class="o">.</span><span class="n">allowed_literals</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">compiled</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Fast set lookup</span>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a>        <span class="n">filter_obj</span><span class="o">.</span><span class="n">allowed_patterns</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pattern</span><span class="p">,</span> <span class="n">compiled</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># Regex match</span>
</code></pre></div>
<h3 id="status-updates">Status Updates<a class="headerlink" href="#status-updates" title="Permanent link">&para;</a></h3>
<p>Update status in handlers:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="nd">@kopf</span><span class="o">.</span><span class="n">on</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;clusterpulse.io&quot;</span><span class="p">,</span> <span class="s2">&quot;v1alpha1&quot;</span><span class="p">,</span> <span class="s2">&quot;monitoraccesspolicies&quot;</span><span class="p">)</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">policy_changed</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>        <span class="n">compiled</span> <span class="o">=</span> <span class="n">policy_compiler</span><span class="o">.</span><span class="n">compile_policy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>        <span class="n">policy_store</span><span class="o">.</span><span class="n">store_policy</span><span class="p">(</span><span class="n">compiled</span><span class="p">)</span>
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a>
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>        <span class="c1"># Success status</span>
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a>        <span class="n">patch</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a>            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;Active&quot;</span><span class="p">,</span>
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a>            <span class="s2">&quot;compiledAt&quot;</span><span class="p">:</span> <span class="n">compiled</span><span class="o">.</span><span class="n">compiled_at</span><span class="p">,</span>
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a>            <span class="s2">&quot;hash&quot;</span><span class="p">:</span> <span class="n">compiled</span><span class="o">.</span><span class="n">hash</span><span class="p">,</span>
<a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a>        <span class="p">}</span>
<a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a>    <span class="k">except</span> <span class="n">PolicyCompilationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a>        <span class="c1"># Error status</span>
<a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a>        <span class="n">patch</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a>            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span>
<a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a>            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
<a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a>            <span class="s2">&quot;error_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
<a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a>        <span class="p">}</span>
</code></pre></div>
<h3 id="dataclass-serialization">Dataclass Serialization<a class="headerlink" href="#dataclass-serialization" title="Permanent link">&para;</a></h3>
<p>Ensure Redis compatibility:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;This format MUST remain unchanged for Redis compatibility&quot;&quot;&quot;</span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>        <span class="s2">&quot;policy_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_name</span><span class="p">,</span>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a>        <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">),</span>  <span class="c1"># Convert sets to lists</span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a>        <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">),</span>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a>        <span class="s2">&quot;cluster_rules&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_rules</span><span class="p">],</span>  <span class="c1"># Nested</span>
<a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a>        <span class="s2">&quot;compiled_at&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_at</span><span class="p">,</span>  <span class="c1"># ISO format string</span>
<a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a>    <span class="p">}</span>
<a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a>
<a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="nd">@classmethod</span>
<a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a><span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CompiledResourceFilter&quot;</span><span class="p">:</span>
<a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Reconstruct from Redis data&quot;&quot;&quot;</span>
<a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a>    <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">visibility</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;visibility&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">))</span>
<a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a>
<a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a>    <span class="c1"># Reconstruct compiled patterns</span>
<a id="__codelineno-45-17" name="__codelineno-45-17" href="#__codelineno-45-17"></a>    <span class="k">for</span> <span class="n">pattern_str</span><span class="p">,</span> <span class="n">regex_str</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allowed_patterns&quot;</span><span class="p">,</span> <span class="p">[]):</span>
<a id="__codelineno-45-18" name="__codelineno-45-18" href="#__codelineno-45-18"></a>        <span class="n">obj</span><span class="o">.</span><span class="n">allowed_patterns</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pattern_str</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex_str</span><span class="p">)))</span>
<a id="__codelineno-45-19" name="__codelineno-45-19" href="#__codelineno-45-19"></a>
<a id="__codelineno-45-20" name="__codelineno-45-20" href="#__codelineno-45-20"></a>    <span class="n">obj</span><span class="o">.</span><span class="n">allowed_literals</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allowed_literals&quot;</span><span class="p">,</span> <span class="p">[]))</span>
<a id="__codelineno-45-21" name="__codelineno-45-21" href="#__codelineno-45-21"></a>    <span class="k">return</span> <span class="n">obj</span>
</code></pre></div>
<h2 id="performance-considerations">Performance Considerations<a class="headerlink" href="#performance-considerations" title="Permanent link">&para;</a></h2>
<h3 id="batch-operations">Batch Operations<a class="headerlink" href="#batch-operations" title="Permanent link">&para;</a></h3>
<p>Always batch Redis operations:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="c1"># DON&#39;T - N individual operations</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>    <span class="n">redis_client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="c1"># DO - Single pipeline</span>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="k">with</span> <span class="n">RedisBatchProcessor</span><span class="p">(</span><span class="n">redis_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">batch</span><span class="p">:</span>
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a>        <span class="n">batch</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span><span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</code></pre></div>
<h3 id="pattern-compilation-caching">Pattern Compilation Caching<a class="headerlink" href="#pattern-compilation-caching" title="Permanent link">&para;</a></h3>
<p>The <code>@lru_cache</code> decorator caches compiled patterns:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">_compile_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>    <span class="c1"># This result is cached - subsequent calls with same pattern are instant</span>
</code></pre></div>
<h3 id="scan-instead-of-keys">SCAN Instead of KEYS<a class="headerlink" href="#scan-instead-of-keys" title="Permanent link">&para;</a></h3>
<p>Use SCAN for large keysets to avoid blocking:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="c1"># DON&#39;T - Blocks Redis</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="n">keys</span> <span class="o">=</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="s2">&quot;policy:eval:*&quot;</span><span class="p">)</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="c1"># DO - Iterative scan</span>
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a>    <span class="n">cursor</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;policy:eval:*&quot;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a>    <span class="c1"># Process keys</span>
<a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a>    <span class="k">if</span> <span class="n">cursor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a>        <span class="k">break</span>
</code></pre></div>
<h3 id="parallel-operations">Parallel Operations<a class="headerlink" href="#parallel-operations" title="Permanent link">&para;</a></h3>
<p>Use <code>asyncio</code> for parallel validation:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">validate_all_policies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>    <span class="n">policies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_store</span><span class="o">.</span><span class="n">list_policies</span><span class="p">()</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>    <span class="c1"># Process in batches</span>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a>    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a>    <span class="k">for</span> <span class="n">policy_key</span> <span class="ow">in</span> <span class="n">policies</span><span class="p">:</span>
<a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a>        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_single_policy</span><span class="p">(</span><span class="n">policy_key</span><span class="p">)</span>
<a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a>        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a>
<a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a>    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<h3 id="metrics-collection-overhead">Metrics Collection Overhead<a class="headerlink" href="#metrics-collection-overhead" title="Permanent link">&para;</a></h3>
<p>Metrics are lightweight but add up. Use labels wisely:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="c1"># Good - Few label values</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="n">policy_errors</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">error_type</span><span class="o">=</span><span class="s2">&quot;validation&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="c1"># Bad - Too many unique label combinations</span>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="n">policy_errors</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a>    <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span>
<a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a>    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a>    <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span>
<a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a>    <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
<a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a>    <span class="n">cluster</span><span class="o">=</span><span class="n">cluster</span>
<a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
</code></pre></div>
<h2 id="common-pitfalls">Common Pitfalls<a class="headerlink" href="#common-pitfalls" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p><strong>Breaking Redis compatibility:</strong>
   <div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="c1">#  Wrong - Changes API expects</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a>        <span class="s2">&quot;policyName&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_name</span><span class="p">,</span>  <span class="c1"># Should be policy_name</span>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>        <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">,</span>              <span class="c1"># Should be list(self.users)</span>
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a>    <span class="p">}</span>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a>
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a><span class="c1">#  Right</span>
<a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a>        <span class="s2">&quot;policy_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_name</span><span class="p">,</span>
<a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a>        <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">),</span>
<a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a>    <span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Not invalidating caches:</strong>
   <div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="c1">#  Wrong - API will serve stale decisions</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">store_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">policy_key</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a>    <span class="c1"># Forgot to clear caches!</span>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a><span class="c1">#  Right</span>
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">store_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">policy_key</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_invalidate_evaluation_caches</span><span class="p">(</span>
<a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a>        <span class="n">policy</span><span class="o">.</span><span class="n">users</span><span class="p">,</span> <span class="n">policy</span><span class="o">.</span><span class="n">groups</span><span class="p">,</span> <span class="n">policy</span><span class="o">.</span><span class="n">service_accounts</span>
<a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a>    <span class="p">)</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Using KEYS instead of SCAN:</strong>
   <div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="c1">#  Wrong - Blocks Redis on large datasets</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="n">keys</span> <span class="o">=</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="s2">&quot;policy:eval:*&quot;</span><span class="p">)</span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="c1">#  Right</span>
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">_scan_and_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>    <span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a>        <span class="n">cursor</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a>        <span class="c1"># Process keys</span>
<a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a>        <span class="k">if</span> <span class="n">cursor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a>            <span class="k">break</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Not handling None values:</strong>
   <div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="c1">#  Wrong - Will crash on None</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="n">allowed</span> <span class="o">=</span> <span class="n">filters</span><span class="p">[</span><span class="s2">&quot;allowed&quot;</span><span class="p">]</span>
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="c1">#  Right</span>
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="n">allowed</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allowed&quot;</span><span class="p">,</span> <span class="p">[])</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Forgetting to update status:</strong>
   <div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="c1">#  Wrong - User doesn&#39;t see compilation errors</span>
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="nd">@kopf</span><span class="o">.</span><span class="n">on</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">policy_changed</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a>    <span class="n">compiled</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">compile_policy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
<a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a>    <span class="c1"># No status update!</span>
<a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a>
<a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a><span class="c1">#  Right</span>
<a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a><span class="nd">@kopf</span><span class="o">.</span><span class="n">on</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">policy_changed</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a>        <span class="n">compiled</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">compile_policy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
<a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a>        <span class="n">patch</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;Active&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">}</span>
<a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a>        <span class="n">patch</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Not using batch processor context manager:</strong>
   <div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="c1">#  Wrong - Manual execution</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="n">batch</span> <span class="o">=</span> <span class="n">RedisBatchProcessor</span><span class="p">(</span><span class="n">redis_client</span><span class="p">)</span>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="n">batch</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span><span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="n">batch</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>  <span class="c1"># Easy to forget!</span>
<a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a>
<a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a><span class="c1">#  Right - Auto-executes</span>
<a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="k">with</span> <span class="n">RedisBatchProcessor</span><span class="p">(</span><span class="n">redis_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">batch</span><span class="p">:</span>
<a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a>    <span class="n">batch</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span><span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Storing sets directly in JSON:</strong>
   <div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="c1">#  Wrong - Sets aren&#39;t JSON serializable</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="n">policy</span><span class="o">.</span><span class="n">users</span><span class="p">})</span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="c1">#  Right - Convert to list</span>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">users</span><span class="p">)})</span>
</code></pre></div></p>
</li>
</ol>
<h2 id="code-style">Code Style<a class="headerlink" href="#code-style" title="Permanent link">&para;</a></h2>
<p>Use <code>black</code> for formatting:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a>uv<span class="w"> </span>run<span class="w"> </span>black<span class="w"> </span>policy_controller.py
</code></pre></div>
<p>Use <code>autoflake</code> to remove unused imports and variables</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a>uv<span class="w"> </span>run<span class="w"> </span>autoflake<span class="w"> </span>--remove-all-unused-imports<span class="w"> </span>--remove-unused-variables<span class="w"> </span>--recursive<span class="w"> </span>--in-place<span class="w"> </span>policy_controller.py
</code></pre></div>
<p>Use <code>isort</code> to sort imports</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a>uv<span class="w"> </span>run<span class="w"> </span>isort<span class="w"> </span>policy_controller.py
</code></pre></div>
<p>Use type hints:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">compile_policy</span><span class="p">(</span>
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>    <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CompiledPolicy</span><span class="p">:</span>
<a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a>    <span class="c1"># Implementation</span>
</code></pre></div>
<p>Docstrings for public methods:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">store_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">CompiledPolicy</span><span class="p">):</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Store compiled policy in Redis with indexes</span>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a>
<a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a><span class="sd">        policy: The compiled policy to store</span>
<a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a>
<a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a><span class="sd">    Raises:</span>
<a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a><span class="sd">        PolicyStorageError: If Redis operation fails</span>
<a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a><span class="sd">    &quot;&quot;&quot;</span>
</code></pre></div>
<h2 id="pull-request-process">Pull Request Process<a class="headerlink" href="#pull-request-process" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p><strong>Branch naming:</strong> <code>feature/add-configmap-filter</code> or <code>fix/cache-invalidation</code></p>
</li>
<li>
<p><strong>Commits:</strong></p>
</li>
<li> "Add ConfigMap resource filter support"</li>
<li> "Fix cache invalidation for service accounts"</li>
<li>
<p> "WIP" or "Fix stuff"</p>
</li>
<li>
<p><strong>Before submitting:</strong>
   <div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="c1"># Format code</span>
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>uv<span class="w"> </span>run<span class="w"> </span>black<span class="w"> </span>policy_controller.py
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a>
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="c1"># Run tests - TODO</span>
<a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a>uv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w"> </span>tests/
<a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a>
<a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a><span class="c1"># Check types</span>
<a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a>uv<span class="w"> </span>run<span class="w"> </span>mypy<span class="w"> </span>policy_controller.py
<a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a>
<a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a><span class="c1"># Test with real CRD</span>
<a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a>oc<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>examples/policy.yaml
</code></pre></div></p>
</li>
<li>
<p><strong>PR description should include:</strong></p>
</li>
<li>What changed and why</li>
<li>Redis format changes (critical!)</li>
<li>Impact on API RBAC engine</li>
<li>
<p>How to test it</p>
</li>
<li>
<p><strong>Things reviewers look for:</strong></p>
</li>
<li>Redis format compatibility maintained</li>
<li>Cache invalidation is correct</li>
<li>Status updates on errors</li>
<li>Batch operations used</li>
<li>Metrics added for new operations</li>
<li>Tests cover new functionality</li>
</ol>
<h2 id="coordination-with-api">Coordination with API<a class="headerlink" href="#coordination-with-api" title="Permanent link">&para;</a></h2>
<p>The policy-controller and API are tightly coupled through Redis:</p>
<p><strong>Policy Controller writes:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="p">{</span>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>    <span class="s2">&quot;policy_name&quot;</span><span class="p">:</span> <span class="s2">&quot;dev-policy&quot;</span><span class="p">,</span>
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a>    <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;user1&quot;</span><span class="p">],</span>
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>    <span class="s2">&quot;cluster_rules&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">...</span><span class="p">],</span>
<a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>API reads:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="c1"># api/services/rbac.py</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="n">policy_data</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="n">policy_key</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="n">policy</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">policy_data</span><span class="p">)</span>
<a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a><span class="n">users</span> <span class="o">=</span> <span class="n">policy</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span>
</code></pre></div></p>
<p><strong>Critical:</strong> Any change to the compiled format requires coordinated deployment:
1. Update policy-controller code
2. Update API RBAC engine code
3. Deploy policy-controller first
4. Recompile all policies (triggers update handlers)
5. Deploy API</p>
<p><strong>Safe changes:</strong>
- Adding optional fields (with defaults in API)
- Adding new filter types (ignored if API doesn't check)
- Adding metrics</p>
<p><strong>Breaking changes:</strong>
- Renaming fields
- Changing data types
- Removing fields</p>
<h2 id="quick-reference">Quick Reference<a class="headerlink" href="#quick-reference" title="Permanent link">&para;</a></h2>
<h3 id="environment-variables">Environment Variables<a class="headerlink" href="#environment-variables" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="nv">NAMESPACE</span><span class="o">=</span>clusterpulse<span class="w">                 </span><span class="c1"># Operator namespace</span>
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="nv">REDIS_HOST</span><span class="o">=</span>redis<span class="w">                       </span><span class="c1"># Redis host</span>
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="nv">REDIS_PORT</span><span class="o">=</span><span class="m">6379</span><span class="w">                        </span><span class="c1"># Redis port</span>
<a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a><span class="nv">REDIS_PASSWORD</span><span class="o">=</span><span class="w">                        </span><span class="c1"># Redis password (optional)</span>
<a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a><span class="nv">POLICY_CACHE_TTL</span><span class="o">=</span><span class="m">300</span><span class="w">                   </span><span class="c1"># Cache TTL in seconds</span>
<a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a><span class="nv">POLICY_VALIDATION_INTERVAL</span><span class="o">=</span><span class="m">300</span><span class="w">         </span><span class="c1"># Validation interval</span>
<a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a><span class="nv">MAX_POLICIES_PER_USER</span><span class="o">=</span><span class="m">100</span><span class="w">              </span><span class="c1"># User policy limit</span>
</code></pre></div>
<h3 id="common-redis-keys">Common Redis Keys<a class="headerlink" href="#common-redis-keys" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a>policy:{namespace}:{name}              # Policy data
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a>policy:user:{user}                     # User&#39;s policies
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a>policy:group:{group}                   # Group&#39;s policies
<a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a>policy:eval:{identity}:{cluster}       # Evaluation cache
<a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a>user:groups:{username}                 # User&#39;s groups
</code></pre></div>
<h3 id="useful-commands">Useful Commands<a class="headerlink" href="#useful-commands" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="c1"># Development</span>
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="nb">cd</span><span class="w"> </span>policy-controller
<a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>uv<span class="w"> </span>run<span class="w"> </span>python<span class="w"> </span>policy_controller.py
<a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a>
<a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a><span class="c1"># Testing - TODO</span>
<a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a>uv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w"> </span>tests/
<a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a>
<a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a><span class="c1"># Format</span>
<a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a>uv<span class="w"> </span>run<span class="w"> </span>black<span class="w"> </span>policy_controller.py
<a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a>
<a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a><span class="c1"># Remove unused imports</span>
<a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a>uv<span class="w"> </span>run<span class="w"> </span>autoflake<span class="w"> </span>--remove-all-unused-imports<span class="w"> </span>--remove-unused-variables<span class="w"> </span>--recursive<span class="w"> </span>--in-place<span class="w"> </span>&lt;path&gt;
<a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a>
<a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a><span class="c1"># Sort imports</span>
<a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a>uv<span class="w"> </span>run<span class="w"> </span>isort<span class="w"> </span>&lt;path&gt;
<a id="__codelineno-68-16" name="__codelineno-68-16" href="#__codelineno-68-16"></a>
<a id="__codelineno-68-17" name="__codelineno-68-17" href="#__codelineno-68-17"></a><span class="c1"># Check Redis</span>
<a id="__codelineno-68-18" name="__codelineno-68-18" href="#__codelineno-68-18"></a>redis-cli
<a id="__codelineno-68-19" name="__codelineno-68-19" href="#__codelineno-68-19"></a>&gt;<span class="w"> </span>KEYS<span class="w"> </span>policy:*
<a id="__codelineno-68-20" name="__codelineno-68-20" href="#__codelineno-68-20"></a>&gt;<span class="w"> </span>HGETALL<span class="w"> </span>policy:clusterpulse:dev-policy
<a id="__codelineno-68-21" name="__codelineno-68-21" href="#__codelineno-68-21"></a>&gt;<span class="w"> </span>SMEMBERS<span class="w"> </span>policy:user:john.doe
<a id="__codelineno-68-22" name="__codelineno-68-22" href="#__codelineno-68-22"></a>
<a id="__codelineno-68-23" name="__codelineno-68-23" href="#__codelineno-68-23"></a><span class="c1"># Watch logs</span>
<a id="__codelineno-68-24" name="__codelineno-68-24" href="#__codelineno-68-24"></a>oc<span class="w"> </span>logs<span class="w"> </span>-f<span class="w"> </span>-n<span class="w"> </span>clusterpulse<span class="w"> </span>deployment/policy-controller
</code></pre></div>
<h3 id="kopf-commands">Kopf Commands<a class="headerlink" href="#kopf-commands" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="c1"># Run with debug logging</span>
<a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a>uv<span class="w"> </span>run<span class="w"> </span>kopf<span class="w"> </span>run<span class="w"> </span>policy_controller.py<span class="w"> </span>--verbose
<a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a>
<a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a><span class="c1"># Run in standalone mode (no leader election)</span>
<a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a>uv<span class="w"> </span>run<span class="w"> </span>kopf<span class="w"> </span>run<span class="w"> </span>policy_controller.py<span class="w"> </span>--standalone
<a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a>
<a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a><span class="c1"># Configure namespace</span>
<a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a>uv<span class="w"> </span>run<span class="w"> </span>kopf<span class="w"> </span>run<span class="w"> </span>policy_controller.py<span class="w"> </span>--namespace<span class="o">=</span>clusterpulse
</code></pre></div>
<h2 id="getting-help">Getting Help<a class="headerlink" href="#getting-help" title="Permanent link">&para;</a></h2>
<ul>
<li>Review RBAC engine in API (<code>api/services/rbac.py</code>) to understand usage</li>
<li>Read kopf documentation: https://kopf.readthedocs.io</li>
<li>Check Redis data directly with <code>redis-cli</code> to debug storage issues</li>
<li>Look at Prometheus metrics for performance insights</li>
</ul>
<h2 id="project-specific-notes">Project-Specific Notes<a class="headerlink" href="#project-specific-notes" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Single file architecture:</strong> All code in one file, organized by sections</li>
<li><strong>Redis is the contract:</strong> Format cannot change without API coordination</li>
<li><strong>Kopf framework:</strong> Uses decorators for event handlers</li>
<li><strong>Batch everything:</strong> Redis operations should use pipelines</li>
<li><strong>Cache invalidation is critical:</strong> Stale caches cause incorrect authorization</li>
<li><strong>Pattern compilation is cached:</strong> Same patterns reused across policies</li>
<li><strong>Status updates in CRD:</strong> Users see compilation errors/success in oc</li>
<li><strong>Metrics for observability:</strong> All operations instrumented with Prometheus</li>
</ul>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/ClusterPulse/clusterpulse" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy", "content.code.annotate", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>